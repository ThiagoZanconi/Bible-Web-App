@page "/search"
@using BlazorApp.Components.Pages.SearchComponents
@using BlazorApp.Components.Services
@using BlazorApp.Model
@rendermode InteractiveServer
@inject IBibleApiService BibleApiService

<div class="px-8"> 
    <div >
        <div class="w-100 mx-auto">
            <div class="text-center">
                <button class="wheat-button dropdown-toggle w-25" @onclick=ToggleDropdown>
                    @selectedBook?.name
                </button>
                @if(show){
                    <div class="w-75 dropdown-custom">
                        @if(books!=null){
                            @foreach(var book in books){
                                <div class="text-center wheat-button" @onclick="() => SetSelected(book)">@book.name</div>
                            }
                        }
                    </div>
                }
            </div>
        </div>

        <div class="text-center mt-3" >     
            <div class="d-flex w-75 form-control px-3 mx-auto">
                <InputText type="text" class="w-100 fs-5 fw-bold p-3 border-none" placeholder="Keyword" @bind-Value="keyword" @onkeydown="EnterPressed" />
                <button class="rounded add-button" @onclick="() => AddKeyword(keyword)">
                    +
                </button>
            </div>

            <div class="px-2">
                <div class="row row-cols row-cols-2-md row-cols-3-lg p-3 g-3">
                    @foreach(var key in keywords){
                        <div class="col d-flex justify-content-start">
                            <div class="d-flex mr-2 my-auto mt-2">
                                @key
                            </div>
                            <button class="btn btn-danger-hover d-flex align-items-center" @onclick="() => RemoveKeyword(key)">
                                <img src="images/trash-can-icon.svg" width="16" height="16" alt="Eliminar">
                            </button>
                        </div>
                    }
                </div>
            </div>

            <div class="w-50 mx-auto mt-3 mb-3">
                <button class="w-50 wheat-button" @onclick="SearchVerses">
                    Search
                </button>
            </div>
            @if (keywordSearch != null)
            {
                <VersesComponent
                    verses="keywordSearch.verses"
                    @key="keywordSearch"
                    @ref="versesComponent" />
                <PaginationComponent currentIndex="keywordSearch.index" maxIndex="keywordSearch.maxIndex"> </PaginationComponent>
            }
            else{
                <p class="text-center mt-3"> No verses found. </p>
            }
        </div>
    </div>
</div>
@code{
    [Inject]
    private HttpClient Http { get; set; } = default!;
    public List<Book>? books;
    private Book? selectedBook; 
    private string keyword = String.Empty;
    private List<string> keywords = new();
    private KeywordSearch? keywordSearch;
    private VersesComponent? versesComponent;
    private bool show;

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            books = await BibleApiService.GetBooksAsync();
            Book any = new Book{id = "ANY", name="ANY"};
            books?.Insert(0, any);
            StateHasChanged(); 
        }
    }
    private void ToggleDropdown(){
        show = !show;
    }
    private void SetSelected(Book book){
        selectedBook = book;
        ToggleDropdown();
    }
    private async void SearchVerses(){
        string keywordsString = string.Join(",", keywords);
        await FetchVerses(keywordsString);
        StateHasChanged();
    }
    private async Task FetchVerses(string keywords){
        if(selectedBook == null || selectedBook.name=="ANY")
        {
            keywordSearch = await BibleApiService.GetVersesByKeywordsAsync(keywords);
        }
        else{
            keywordSearch = await BibleApiService.GetVersesInBookByKeywordsAsync(selectedBook.id, keywords);
        }
        await InvokeAsync(StateHasChanged);
    }
    private void EnterPressed(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddKeyword(keyword);
        }
    }
    private void AddKeyword(string key){
        if(keyword!=""){
            keywords.Add(key);
            keyword="";
        }
        StateHasChanged();
    }
    private void RemoveKeyword(string key){
        keywords.Remove(key);
    }
}