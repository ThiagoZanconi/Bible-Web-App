@page "/calendar"
@using BlazorApp.Components.Services
@using BlazorApp.Model
@using System.Text.Json
@using System.ComponentModel
@inject ICalendarApiService CalendarApiService
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<div class="px-3">
    <div class="d-flex">
        <h1> Orthodox Calendar </h1>
        <button class="button" @onclick="() => setCalendar(julian)"> Julian </button>
        <button class="button" @onclick="() => setCalendar(gregorian)"> Gregorian </button>
    </div>
    <div class="text-center p-3 m-3 border border-2 border-dark rounded">
        @if (calendarDay != null){
            <div class="d-flex gap-4 justify-content-center mb-3">
                <button class="button" @onclick= "() => setPreviousDay()">Prev</button>
                <h2>@calendarDay.year, @calendarDay.month, @calendarDay.day </h2>
                <button class="button" @onclick= "() => setNextDay()">Next</button>
            </div>
            @if(calendarDay.titles!=null){
                @foreach( var title in calendarDay.titles){
                    <h3> @title </h3>
                }
            }
            <h4> @calendarDay.fast_exception_desc </h4>
            
            @if(calendarDay.feasts!=null){
                <h4> Feasts: </h4>
                <ol class="plain-list">
                    @foreach( var feast in calendarDay.feasts){
                        <li> @feast </li>
                    }
                </ol>
            }
            
            <h4> Saints: </h4>
            @if(calendarDay.saints!=null)  {
                <ol class="plain-list">
                    @foreach (var saint in calendarDay.saints){
                        <li> @saint </li>
                    }
                </ol>
            }  
        }
        else{
            <p> Loading... </p>
        }
    </div>
</div>

@code{
    private static string julian = "julian";
    private static string gregorian = "gregorian";
    private DateTime today = DateTime.Now;
    private string calendarName { get; set; } = julian;
    private CalendarDay? calendarDay;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender){
            await FetchCalendarToday();
        }
    }

    private async Task FetchCalendarToday(){
        calendarDay = await CalendarApiService.GetToday(calendarName);
        if(calendarDay != null){
            foreach(PropertyDescriptor descriptor in TypeDescriptor.GetProperties(calendarDay))
            {
                string name = descriptor.Name;
                object value = descriptor.GetValue(calendarDay)!;
                Console.WriteLine("{0}={1}", name, value);
            }
        }
        StateHasChanged();
      
    }

    private async Task FetchCalendarDay(string cal, int year, int month, int day){
        
        calendarDay = await CalendarApiService.GetCalendarDay(cal, year, month, day);
        StateHasChanged();
   
    }

    protected async void setCalendar(string calendar){
        calendarName = calendar;
        await FetchCalendarToday();
    } 

    private async void setPreviousDay(){
        if(calendarDay != null)
            await FetchCalendarDay(calendarName, calendarDay.year, calendarDay.month, calendarDay.day-1);
    }  

    private async void setNextDay(){
        if(calendarDay != null)
            await FetchCalendarDay(calendarName, calendarDay.year, calendarDay.month, calendarDay.day+1);
    } 

}