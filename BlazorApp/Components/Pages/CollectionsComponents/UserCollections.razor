@using BlazorApp.Components.Services
@using BlazorApp.Model
@using System.Net.Http.Headers
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IBibleApiService BibleApiService

<div class="row row-cols row-cols-1 p-3 g-3 mt-5">
    @foreach (var collection in collections)
    {
        <div class="d-flex justify-content-center">
            <div class="rounded d-flex w-75">
                <button class="rounded-start wheat-button underline-on-hover h-100" style="width: 90%; padding-left: 100px; padding-right: 100px;" @onclick="()=>NavigateToCollection(collection.name)">
                    @collection.name
                </button>
                <button class="rounded-end cancel-button h-100" style="width: 10%;" @onclick="() => DeleteCollection(collection)">
                    <img src="images/trash-can.svg" width="25" height="25" alt="Eliminar">
                </button>
            </div>
        </div>
    }
</div>

<DeleteConfirmationComponent @ref="DeleteRef" ConfirmDeleteCallback="ConfirmDelete"></DeleteConfirmationComponent>

<NotificationComponent @ref="NotificationRef"></NotificationComponent>
@code{

    [Inject] 
    private HttpClient Http { get; set; } = default!;

    [Parameter]
    public List<Collection> collections { get; set; } = new();
    private string collectionToDelete = String.Empty;
    private DeleteConfirmationComponent? DeleteRef;
    private NotificationComponent? NotificationRef;

    private void DeleteCollection(Collection collection)
    {
        collectionToDelete = collection.name;
        DeleteRef?.ToggleModal();
    }
    private async void ConfirmDelete()
    {
        bool deletedCollection = await DeleteCollectionRequest(collectionToDelete);
        if(deletedCollection){
            collections.Remove(collections.FirstOrDefault(c => c.name == collectionToDelete)!);
            StateHasChanged();
        }
    }
    private async Task<bool> DeleteCollectionRequest(string name){
        var token = await localStorage.GetItemAsync<string>("jwtToken");
        bool toReturn = false;
        if(token!=null){
            toReturn = await BibleApiService.DeleteCollectionAsync(token, name);

        }
        NotificationRef?.notifyCollectionElimination(toReturn);
        return toReturn;
    }
    private void NavigateToCollection(string name){
        Navigation.NavigateTo("/collection/"+name);
    }
}